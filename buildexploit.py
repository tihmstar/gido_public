
import struct
import binascii
import subprocess
import sys

binName = "gido.o"

jtool = subprocess.Popen(["jtool", "-l",binName], stdout=subprocess.PIPE)

regsizes = []
lastregend = 0
for l in jtool.stdout.read().split("\n"):
    if not "Mem" in l or "LC 00" in l or "nl_symbol_ptr" in l:
        continue
    reg = l.split(": ")[1].split("\t")[0]
    start = reg.split("-")
    end = int(start[1],16)
    start = int(start[0],16)
    pad = start-lastregend
    lastregend = end
    size = end-start
    section = l.split("\t")[3]
    regsizes.append([pad,size,section])
    # print hex(start),hex(end),hex(size)

# print regsizes
explbin = ""
for reg in regsizes:
    f = open(binName+"."+reg[2],"rb")
    r = f.read()
    f.close()
    explbin += "\x00"*reg[0]
    explbin += r
    # print binascii.hexlify(explbin)+"\n\n"

while len(explbin) % 4:
    explbin += "A"

p = open(binName.replace(".o",".bin"),"wb")
p.write(explbin)
p.close()

print "done building exploit"
